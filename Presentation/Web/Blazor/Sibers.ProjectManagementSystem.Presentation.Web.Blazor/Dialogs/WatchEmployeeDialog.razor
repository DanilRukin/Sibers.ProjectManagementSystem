@using MediatR
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Dtos
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Infrastructure.Employees.Queries
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Infrastructure.Extensions
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Infrastructure.Projects.Queries
@using Sibers.ProjectManagementSystem.SharedKernel

@inject IMediator Mediator
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer>
            @if (EmployeeToWatch == null)
            {
                <MudProgressCircular Indeterminate="true"></MudProgressCircular>
            }
            else
            {
                <MudText GutterBottom="true" Typo="Typo.h6">
                    Фамилия Имя Отчество
                </MudText>
                <MudText GutterBottom="true" Typo="Typo.h4">
                    @EmployeeToWatch.FirstName @EmployeeToWatch.LastName @EmployeeToWatch.Patronymic
                </MudText>
                <MudText GutterBottom="true" Typo="Typo.h6">
                    Email
                </MudText>
                <MudText GutterBottom="true" Typo="Typo.h4">
                    @EmployeeToWatch.Email
                </MudText>
                <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-5">
                    Задействован на проектах
                </MudText>
                @if (EmployeeToWatch.ProjectsIds == null)
                {
                    <MudProgressCircular Indeterminate="true"></MudProgressCircular>
                }
                else
                {
                    <MudTable Items="_projects" Hover="true">
                        <HeaderContent>
                            <MudTh>
                                Название проекта
                            </MudTh>
                            <MudTh>
                                Роль на проекте
                            </MudTh>
                        </HeaderContent>
                        <RowTemplate Context="ep">
                            <MudTd DataLabel="Название проекта">@ep.Name</MudTd>
                            <MudTd DataLabel="Роль на проекте">
                                @(() => @ep.ManagerId == EmployeeToWatch.Id ? "Менеджер" : "Сотрудник")
                            </MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[] { 5, 10, 15}" />
                        </PagerContent>
                    </MudTable>
                }
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Назад</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    /// <summary>
    /// Employee to watch
    /// </summary>
    [Parameter]
    public EmployeeDto EmployeeToWatch { get; set; }

    private ICollection<ProjectDto> _projects;

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
    }

    private async Task LoadProjects()
    {
        if (EmployeeToWatch != null)
        {
            if (EmployeeToWatch.ProjectsIds == null || EmployeeToWatch.ProjectsIds.Count == 0)
            {
                GetEmployeeByIdQuery query = new GetEmployeeByIdQuery(EmployeeToWatch.Id, true);
                Result<EmployeeDto> employeeResult = await Mediator.Send(query);
                if (!employeeResult.IsSuccess)
                {
                    Snackbar.Add($"Произошла ошибка при обновлении данных сотрудника. Причина: {employeeResult.Errors.AsOneString()}", Severity.Error);
                }
                else
                {
                    EmployeeToWatch = employeeResult.Value;
                }
            }
            GetRangeOfProjectsQuery projectsQuery = new GetRangeOfProjectsQuery(EmployeeToWatch.ProjectsIds, true);
            var projectsResult = await Mediator.Send(projectsQuery);
            if (!projectsResult.IsSuccess)
            {
                Snackbar.Add($"Не удалось загрузить проекты сотрудника. Причина: {projectsResult.Errors.AsOneString()}", Severity.Error);
                _projects = new List<ProjectDto>();
            }
            else
                _projects = projectsResult.Value.ToList();
        }
        else
        {
            Snackbar.Add("Не удалось получить сотрудника.", Severity.Warning);
            EmployeeToWatch = new EmployeeDto();
        }   
    }

    private void Cancel() => MudDialog.Cancel();
}

