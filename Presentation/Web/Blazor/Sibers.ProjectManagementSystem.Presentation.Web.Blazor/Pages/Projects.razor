@page "/projects"

@using MediatR
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Dtos
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Infrastructure.Extensions
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Infrastructure.Projects.Commands
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Infrastructure.Projects.Queries
@using Sibers.ProjectManagementSystem.Presentation.Web.Blazor.Dialogs
@using Sibers.ProjectManagementSystem.SharedKernel
@using Sibers.ProjectManagementSystem.SharedKernel.Results

@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IMediator Mediator

@if (_projects == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudFab Style="position:fixed; bottom:10px; right:10px;" Color="Color.Success"
        StartIcon="@Icons.Material.Filled.Add" @onclick="OnCreateProject" />
    <MudText Typo="Typo.h3" GutterBottom="true">Проекты</MudText>
    @if (_projects.Count() == 0)
    {
        <MudText Typo="Typo.h5" GutterBottom="true">Здесь ничего нет</MudText>
    }
    else
    {
        <MudTable Style="height:stretch;" Items="_projects" FixedHeader="true" FixedFooter="true" Hover="true" SortLabel="Sort by">
            <HeaderContent>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ProjectDto, object>(e => e.Id)">
                        Id
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ProjectDto, object>(e => e.Name)">
                        Название проекта
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ProjectDto, object>(e => e.NameOfTheCustomerCompany)">
                        Компания-заказчик
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ProjectDto, object>(e => e.NameOfTheContractorCompany)">
                        Компания-исполнитель
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ProjectDto, object>(e => e.StartDate)">
                        Дата начала проекта
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ProjectDto, object>(e => e.EndDate)">
                        Дата окончания проекта
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ProjectDto, object>(e => e.Priority)">
                        Приоритет
                    </MudTableSortLabel>
                </MudTh>
                <MudTh Style="width:200px;">
                    Действие
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Id</MudTd>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.NameOfTheCustomerCompany</MudTd>
                <MudTd>@context.NameOfTheContractorCompany</MudTd>
                <MudTd>@context.StartDate</MudTd>
                <MudTd>@context.EndDate</MudTd>
                <MudTd>@context.Priority</MudTd>
                <MudTd>
                    <MudIconButton Color="Color.Info" Variant="Variant.Filled" Icon="@Icons.Filled.RemoveRedEye" @onclick="@(() => OnWatchProject(context.Id))">
                    </MudIconButton>
                    <MudIconButton Color="Color.Success" Variant="Variant.Filled" Icon="@Icons.Filled.Edit" @onclick="@(() => OnProjectEdit(context.Id))">
                    </MudIconButton>
                    <MudIconButton Color="Color.Error" Variant="Variant.Filled" Icon="@Icons.Filled.Delete" @onclick="@(() => OnProjectDeleting(context.Id))">
                    </MudIconButton>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    }
}


@code {
    private ICollection<ProjectDto> _projects;

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
    }

    private async Task LoadProjects()
    {
        _projects = (ICollection<ProjectDto>)await Mediator.Send(new GetAllProjectsQuery(false));
    }

    private async Task OnCreateProject()
    {
        var options = new DialogOptions
            {
                CloseButton = true,
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Large,
                FullWidth = true
            };
        var dialog = DialogService.Show<CreateProjectDialog>("Создание проекта", options);
        using var task = dialog.Result;
        var result = await task;
        if (result != null && !result.Cancelled && (result.Data is ProjectDto createdProject))
        {
            _projects.Add(createdProject);
        }
    }

    private async Task OnWatchProject(int projectId)
    {
        var options = new DialogOptions
            {
                CloseButton = true,
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Large,
                FullWidth = true
            };
        DialogParameters parameters = new DialogParameters();
        GetProjectByIdQuery query = new GetProjectByIdQuery(projectId, false);
        ProjectDto project = await Mediator.Send(query);
        if (project == null)
        {
            Snackbar.Add("Ошибка при загрузке данных проекта", Severity.Error);
        }
        parameters.Add("Project", project);
        var dialog = DialogService.Show<WatchProjectDialog>("Информация о проекте", parameters, options);
    }

    private async Task OnProjectDeleting(int projectId)
    {
        bool? result = await DialogService.ShowMessageBox(
            title: $"Удаление проекта {projectId}",
            markupMessage: new MarkupString("Вы действительно хотите удалить проект? Действие невозможно будет отменить"),
            yesText: "Удалить",
            cancelText: "Отмена"
        );
        if (result != null && result == true)
        {
            DeleteProjectCommand deleteCommand = new(projectId);
            Result deleteResult = await Mediator.Send(deleteCommand);
            if (deleteResult.IsSuccess)
            {
                _projects.RemoveWithCriterion(p => p.Id == projectId);
                Snackbar.Add("Проект успешно удален.", Severity.Success);
            }
            else
            {
                Snackbar.Add(deleteResult.Errors.AsOneString(), Severity.Error);
            }
        }
    }

    protected async Task OnProjectEdit(int projectId)
    {
        var options = new DialogOptions
            {
                CloseButton = true,
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Large,
                FullWidth = true
            };
        ProjectDto? project = _projects.FirstOrDefault(p => p.Id == projectId);
        DialogParameters parameters = new DialogParameters();
        parameters.Add(nameof(EditProjectDialog.ProjectToEdit), project);
        var dialog = DialogService.Show<EditProjectDialog>("Управление проектом", parameters, options);
        using var task = dialog.Result;
        var result = await task;
        if (result != null && !result.Cancelled && (result.Data is bool ok))
        {
            if (ok)
            {
                GetProjectByIdQuery query = new(projectId, false);
                ProjectDto updatedProject = await Mediator.Send(query);
                if (updatedProject == null)
                {
                    Snackbar.Add("Не удалось получить обновленные данные проекта.");
                }
                else
                {
                    _projects.RemoveWithCriterion(p => p.Id == projectId);
                    _projects.Add(updatedProject);
                }
            }
        }
    }
}

